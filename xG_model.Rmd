---
title: "xG_model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=T}
library(tidyverse)
library(tidyselect)
library(glmnet)
library(caret)
```

Getting the data
```{r}
events_summary <- read_csv("data/events_summary_df.csv")
game_info <- read_csv("data/game_info_df.csv")
pbp_base <- read_csv("data/pbp_base.csv")
pbp_extras <- read_csv("data/pbp_extras.csv")
player_periods <- read_csv("data/player_periods.csv")
player_shifts <- read_csv("data/player_shifts.csv")
report <- read_csv("data/report.csv")
roster <- read_csv("data/roster_df.csv")
scratches <- read_csv("data/scratches_df.csv")
```

Variables needed to make model
  shot type
  shooter indicator
  goalie indicator
  goal state
  strength state
  last event


Proccessing data
```{r}
data_pipeline_xG <- function(pbp){
  # events_to_remove <- c("ANTHEM", "CHANGE", "CHL", "EGPID", 
  #                       "EIEND", "EISTR", "GEND", "GOFF", 
  #                       "PEND", "PGEND", "PGSTR", "PSTR", "STOP")
  
  new_pbp <- pbp %>% filter(event_type %in% c("SHOT", "GOAL")) %>%
                  mutate(GF = home_score,
                         GA = away_score,
                         num_home_players = str_extract(game_strength_state, "^."),
                         num_away_players = str_extract(game_strength_state, ".$"),
                         num_home_players = ifelse(num_home_players == "E", 
                                                          ifelse(game_seconds < 3600, "5", "3"), 
                                                         num_home_players),
                         num_away_players = ifelse(num_away_players == "E", 
                                                          ifelse(game_seconds < 3600, "5", "3"),
                                                          num_away_players),
                         num_home_players = as.numeric(num_home_players),
                         num_away_players = as.numeric(num_away_players),
                         goalie = ifelse(event_team == home_team, home_goalie, away_goalie),
                         shooter = event_player_1,
                         y = coords_y,
                         x = abs(coords_x),
                         isgoal=ifelse(event_type == "GOAL", 1, 0)) %>%
                  dplyr::select("GF", "GA", "num_home_players", "num_away_players", 
                                "event_detail", "x", "y", "shooter", 
                                "goalie", "event_team", "isgoal", "game_id") %>%
                  drop_na()
  
  dummy_event_detail <- dummyVars("~event_detail+goalie+shooter+event_team", data=new_pbp, fullRank = TRUE) %>%
                          predict(., newdata=new_pbp) %>%
                          data.frame(.)

  new_pbp <- bind_cols(new_pbp %>% dplyr::select("GF", "GA", "num_home_players", "num_away_players", "x", "y", "isgoal"), 
                       dummy_event_detail)
  return(new_pbp)
  
}
test_pbp <- data_pipeline_xG(pbp_base)
```


```{r}
# apply(test_pbp, 2, function(x) any(is.na(x)))
# test_pbp[is.na(test_pbp$event_detail), ]

X <- test_pbp %>% dplyr::select(-"isgoal") %>% data.matrix(.)
y <- test_pbp$isgoal

model <- cv.glmnet(X, y, family="binomial", alpha=0)

model_coef <- coef(model, s="lambda.min")
model_coef_names <- model_coef@Dimnames[[1]][model_coef@i + 1]
model_coef <- as_tibble(data.frame(name = model_coef_names, coefficient = model_coef@x))
# ggplot(data=test_pbp %>% filter(shooterALEX.OVECHKIN == 1) , aes(x=x, y=y)) + coord_cartesian(xlim=c(0,100)) + 
#   coord_cartesian(ylim=c(-42, 42)) + geom_density_2d_filled()
# ggplot(data=test_pbp %>% filter(shooterTJ.BRODIE == 1) , aes(x=x, y=y)) + coord_cartesian(xlim=c(0,100)) + 
#   coord_cartesian(ylim=c(-42, 42)) + geom_density_2d_filled()
```

```{r}
test <- matrix(0, 42*2*100, 1023)
test[c(3,4), ] <- 5
# test[c(5,6), ] <- crossing(c(-42:42), c(0:100))
```



