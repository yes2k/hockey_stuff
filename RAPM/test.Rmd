---
title: "test"
author: "Yatharth Khattar"
date: "20/02/2021"
output: html_document
---

```{r message=FALSE}
library(tidyverse)
```

```{r}
get_rapm_data_per_game <- function(pbp){
  shift_data <- pbp %>% filter(event_type == "CHANGE") %>% 
                mutate(is_home_team_event = if_else(event_team == home_team, 
                                                    1, 0)) %>% 
                select(game_id, game_seconds, event_team, 
                       paste0("away_on_", 1:7), paste0("home_on_", 1:7), 
                       is_home_team_event, home_goalie, away_goalie, 
                       home_team, away_team) %>% 
                group_by(game_seconds) %>% 
                slice(n()) %>% 
                ungroup(game_seconds) %>% 
                mutate(shift_start = game_seconds,
                       shift_end = lead(game_seconds)) %>%   
                head(-1) %>% 
                mutate(across(c(home_on_1:home_on_7, away_on_1:away_on_7), 
                              function(x){
                                          ifelse(x==home_goalie, NA, 
                                          ifelse(x==away_goalie, NA, x))})) 

  shift_times <- shift_data[c("shift_start", "shift_end")]
  
  shot_type <- c("BLOCK", "GOAL", "MISS", "SHOT")
  shot_data  <- pbp %>% filter(event_type %in% shot_type) %>% 
                  dplyr::select(game_seconds, event_team, event_type, home_team,
                                away_team) %>% 
                  mutate(is_home_team = if_else(event_team == home_team, 1, 0))
  
  home_team_shot_times <- shot_data %>% 
                          filter(is_home_team == 1) %>% 
                          pull(game_seconds)
    
  away_team_shot_times <- shot_data %>% 
                          filter(is_home_team == 0) %>% 
                          pull(game_seconds)
  
  final_shift_data <- apply(shift_times, 1, function(x){
    home_team_shot <- sum(x[["shift_start"]] <= home_team_shot_times &
                          home_team_shot_times < x[["shift_end"]])
    away_team_shot <- sum(x[["shift_start"]] <= away_team_shot_times &
                          away_team_shot_times < x[["shift_end"]])
    return(tibble(home_team_shots = home_team_shot, 
                  away_team_shots = away_team_shot))
  }) %>% bind_rows(.) %>% bind_cols(., shift_data) %>% 
    mutate(home_team_shots_per_60 = (home_team_shots/(shift_end - shift_start))*3600,
           away_team_shots_per_60 = (away_team_shots/(shift_end - shift_start))*3600) 
  
  # TODO: Double each row and make columns for offensive players and defensive players
  #       and also create a dummy variable that is 1 if home team == offensive team
  
  # %>% 
  #   pmap_df(function(...){
  #     arg <- list(...)
  #     new_dat <- tibble(game_id=numeric(), shift_start=numeric(), shift_end=numeric(), 
  #            shots_per_60=numeric(), offensive_player_1=character(), 
  #            offensive_player_2=character(), offensive_player_3=character(), 
  #            offensive_player_4=character(), offensive_player_5=character(), 
  #            offensive_player_6=character(),  offensive_player_7=character(),
  #            defensive_player_1=character(), defensive_player_2=character(), 
  #            defensive_player_3=character(), defensive_player_4=character(), 
  #            defensive_player_5=character(), defensive_player_6=character(), 
  #            defensive_player_7=character(), is_home_team = numeric())
  #     new_dat$game_id <- rep(arg$game_id, 2)
  #     
  #   })
}

gid <- 2017020265
v <- get_rapm_data_per_game(pbp_data %>% filter(game_id == gid))
view(v)
```










