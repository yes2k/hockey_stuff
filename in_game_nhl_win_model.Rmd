---
title: "in_game_nhl_win_model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RCurl); library(xml2); library(rvest); library(jsonlite); library(foreach)
library(lubridate)
library(tidyverse)
library(googledrive)
library(arm)
library(caret)
library(glmnet)
```


Modelling ingame nhl win probabilities

want to model P(home team win) while the game is happening

Downloading the Data
```{r message=FALSE}
events_summary <- read_csv("data/events_summary_df.csv")
game_info <- read_csv("data/game_info_df.csv")
pbp_base <- read_csv("data/pbp_base.csv")
pbp_extras <- read_csv("data/pbp_extras.csv")
player_periods <- read_csv("data/player_periods.csv")
player_shifts <- read_csv("data/player_shifts.csv")
report <- read_csv("data/report.csv")
roster <- read_csv("data/roster_df.csv")
scratches <- read_csv("data/scratches_df.csv")
```

Getting shift data

What sort of data are we going to need to?
  seconds into the game
  home strength state (num players home - num players away)
  
  -Not needed
  event type (dummy variables), should also indicate if it's home or away event type 
    goal
    blocked shot
    shot (xG might be a better indicator)
    giveaway
    takeaway
    faceoff
    
  home and away players on ice (dummy var)
  teams (dummy var)
  
  
```{r}
# view(new_pbp %>% filter(game_id == gid))

data_pipeline <- function(pbp){
  cols_to_select <- c("game_id", "game_seconds","home_team", "away_team",
                      "home_score", "away_score", "game_strength_state", "event_type")
  
  events_to_remove <- c("GSTART", "GEND", "PSTART", "PEND")
  
  new_pbp <- pbp %>% 
              filter(game_seconds > 0 & !event_type %in% events_to_remove) %>% 
              dplyr::select(all_of(cols_to_select)) %>%
              mutate(GF = home_score) %>%
              mutate(GA = away_score) %>%
              mutate(num_home_players = str_extract(game_strength_state, "^.")) %>%
              mutate(num_away_players = str_extract(game_strength_state, ".$")) %>%
              mutate(num_home_players = ifelse(num_home_players == "E", 
                                               ifelse(game_seconds < 3600, "5", "3"), 
                                               num_home_players)) %>%
              mutate(num_away_players = ifelse(num_away_players == "E", 
                                               ifelse(game_seconds < 3600, "5", "3"),
                                               num_away_players)) %>%
              mutate(num_home_players = as.numeric(num_home_players)) %>%
              mutate(num_away_players = as.numeric(num_away_players))
    
    
  print(colnames(new_pbp))
  new_pbp <- new_pbp %>% dplyr::select("game_id", "game_seconds", "GF", 
                                       "GA", "game_seconds", "num_home_players", 
                                       "num_away_players")
  new_pbp <- type_convert(new_pbp) 
}

new_pbp <- data_pipeline(pbp_base)
new_pbp %>% filter(game_id == "2018020001")
```

```{r}
y <- game_info %>% mutate(home_team_win=ifelse(home_score>away_score, 1, 0)) %>% 
                  dplyr::select("game_id","home_team_win")
df <- inner_join(y, new_pbp)
model <- glm(home_team_win~., data=df %>% dplyr::select(-c("game_id")), family="binomial")
summary(model) 
```


```{r}
rt_odds_graph <- function(model, pbp, game_info){
  new_pbp <- data_pipeline(pbp)
  odds_home_team_winning <- exp(predict(model, newdata = new_pbp %>% dplyr::select(-c("game_id"))))
  new_pbp <- cbind(new_pbp, odds_home_team_winning)
  print(new_pbp)
  ggplot(new_pbp, aes(x=game_seconds, y=odds_home_team_winning)) + 
    geom_line() + ggtitle(paste("In Game Win Probability Tracker ", game_info$away_team, " @ ", 
                                game_info$home_team, ", ", game_info$game_date, sep="")) +
    theme(plot.title = element_text(hjust = 0.5))

}
gid <- "2018020004"
rt_odds_graph(model, pbp_base %>% dplyr::filter(game_id == gid), game_info %>% dplyr::filter(game_id == gid))
```


