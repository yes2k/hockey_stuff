---
title: "in_game_nhl_win_model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RCurl); library(xml2); library(rvest); library(jsonlite); library(foreach)
library(lubridate)
library(tidyverse)
library(googledrive)
library(arm)
library(caret)
library(glmnet)
```


Modelling ingame nhl win probabilities

want to model P(home team win) while the game is happening

Downloading the Data
```{r message=FALSE}
events_summary <- read_csv("data/events_summary_df.csv")
game_info <- read_csv("data/game_info_df.csv")
pbp_base <- read_csv("data/pbp_base.csv")
pbp_extras <- read_csv("data/pbp_extras.csv")
player_periods <- read_csv("data/player_periods.csv")
player_shifts <- read_csv("data/player_shifts.csv")
report <- read_csv("data/report.csv")
roster <- read_csv("data/roster_df.csv")
scratches <- read_csv("data/scratches_df.csv")
```

Getting shift data

What sort of data are we going to need to?
  seconds into the game
  GF-GA
  home strength state (num players home - num players away)
  event type (dummy variables), should also indicate if it's home or away event type
    blocked shot
    shot (xG might be a better indicator)
    giveaway
    takeaway
    faceoff
  home and away players on ice (dummy var)
  
  
```{r}
event_types <- c("BLOCK", "CHANGE", "HIT", "SHOT", "GIVE", "GOAL")
cols_to_select <- c("game_id", "game_seconds", "event_type",
                    "event_team", "home_team", "away_team",
                    "home_score", "away_score", "game_strength_state")

new_pbp <- pbp_base %>% 
            dplyr::filter(game_seconds > 0 & event_type %in% event_types) %>% 
            dplyr::select(all_of(cols_to_select)) %>%
            dplyr::mutate(GF = str_extract(game_score_state, "^//d")) %>%
            dplyr::mutate(GA = str_extract(game_score_state, "\\d$")) %>%
            dplyr::mutate(num_home_players)

GF <- str_extract(new_pbp_base$game_score_state, "^\\d") %>% as.numeric
GA <- str_extract(new_pbp_base$game_score_state, "\\d$") %>% as.numeric
num_home_players <- str_extract(new_pbp_base$game_strength_state, "^\\d") %>% as.numeric
num_away_players <- str_extract(new_pbp_base$game_strength_state, "\\d$") %>% as.numeric



y <- game_info %>% mutate(home_team_win=ifelse(home_score>away_score, 1, 0)) %>% dplyr::select(game_id, home_team_win)

df <- cbind(new_pbp_base$game_id, new_pbp_base$game_seconds, GF-GA, num_home_players - num_away_players)
colnames(df) <- c("game_id", "game_seconds", "GF-GA", "num_home-away_players")

df <- df %>% as_tibble(.)

```

```{r}
df <- inner_join(y, df)

model <- glm(home_team_win~game_seconds+`GF-GA`+`num_home-away_players`, data=df, family="binomial")

pred <- df %>% dplyr::filter(game_id=="2018020100") %>% dplyr::select(-c(game_id, home_team_win)) %>% 
                    predict(model,newdata=., type="response")
plot.ts(pred)
```

